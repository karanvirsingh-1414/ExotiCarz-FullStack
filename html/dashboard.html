<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Garage - Exoticarz</title>
    <link rel="icon" href="../images/logo-removebg.png">

    <!-- BOOTSTRAP - LINK -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- FONT AWESOME LINK -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

    <!-- Reusing Landing CSS -->
    <link rel="stylesheet" href="../css/landing.css">

    <style>
        body {
            display: none;
        }

        /* Hide by default */
        /* ... existing styles ... */
        body {
            background-color: #050505;
            color: white;
        }


        .dashboard-container {
            padding-top: 100px;
        }

        .glass-panel {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
        }

        .active-ride-card {
            background: linear-gradient(145deg, rgba(20, 20, 20, 0.9), rgba(10, 10, 10, 0.95));
            border: 1px solid var(--gold);
            position: relative;
            overflow: hidden;
        }

        .active-ride-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--gold);
            box-shadow: 0 0 20px var(--gold);
        }

        .stat-card {
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .history-table {
            --bs-table-bg: transparent;
            --bs-table-color: white;
            border-color: rgba(255, 255, 255, 0.1);
        }

        .history-table th {
            font-family: 'Orbitron', sans-serif;
            color: var(--gold);
            font-weight: normal;
            letter-spacing: 1px;
            border-bottom-width: 1px;
        }

        .history-table td {
            font-family: 'Outfit', sans-serif;
            vertical-align: middle;
            color: #ccc;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            object-fit: cover;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-active {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .status-completed {
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
        }
       
    /* ... existing styles ... */

    /* PROFILE MODAL */
    #profile-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(8px);
    z-index: 10000;
    display: none; /* Hidden by default */
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    }

    #profile-modal.show {
    display: flex;
    opacity: 1;
    }

    .profile-content {
    background: rgba(20, 20, 20, 0.95);
    border: 1px solid var(--gold);
    border-radius: 20px;
    padding: 40px;
    width: 90%;
    max-width: 500px;
    text-align: center;
    box-shadow: 0 0 50px rgba(212, 175, 55, 0.2);
    transform: scale(0.9);
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    }

    #profile-modal.show .profile-content {
    transform: scale(1);
    }

    .profile-avatar-large {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 3px solid var(--gold);
    margin-bottom: 20px;
    object-fit: cover;
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
    }

    .stat-row {
    display: flex;
    justify-content: space-between;
    margin: 20px 0;
    padding: 15px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    }

    .stat-item {
    text-align: center;
    flex: 1;
    }

    .stat-item h3 {
    color: var(--gold);
    font-family: 'Orbitron', sans-serif;
    margin-bottom: 5px;
    }

    .stat-item p {
    color: #aaa;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin: 0;
    }

    .car-list-tag {
    background: rgba(212, 175, 55, 0.1);
    color: var(--gold);
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.85rem;
    margin: 5px;
    display: inline-block;
    border: 1px solid rgba(212, 175, 55, 0.3);
    }

    .close-modal-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    color: #aaa;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    transition: color 0.3s;
    }

    .close-modal-btn:hover {
    color: white;
    }

</style>


        /* ... */
    
    
    <script>
        // AUTH GUARD (Run immediately)
        const userStr = localStorage.getItem('currentUser');
        let isValidUser = false;
        if (userStr && userStr !== 'null' && userStr !== 'undefined') {
            try {
                const user = JSON.parse(userStr);
                if (user && user.email) isValidUser = true;
            } catch (e) {
                console.error("Auth Error", e);
            }
        }

        if (!isValidUser) {
            window.location.href = "login_2.html";
        } else {
            // Show body only if valid
            document.addEventListener('DOMContentLoaded', () => {
                document.body.style.display = 'block';
            });
        }
    </script>


</head>

<body>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg fixed-top navbar-dark" id="mainNav" style="background: rgba(0,0,0,0.9);">
        <div class="container">
            <a class="navbar-brand" href="landing.html">
                <img src="../images/logo-removebg.png" alt="Exoticarz Logo" class="nav-logo">
            </a>

            <div class="d-flex align-items-center gap-4 ms-auto">
                <div class="d-none d-md-block text-end">
                    <p class="text-white font-orbitron mb-0 small">Welcome back,</p>
                    <p class="text-warning font-outfit mb-0 fw-bold">Karanvir Singh</p>
                </div>
                <img src="https://ui-avatars.com/api/?name=Karanvir+Singh&background=D4AF37&color=000"
                    class="user-avatar" alt="User" onclick="openProfileModal()"
                    style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'"
                    onmouseout="this.style.transform='scale(1)'">
                <button onclick="logout()" class="btn btn-outline-secondary btn-sm rounded-pill px-3 ms-2"><i
                        class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </div>
    </nav>

    <div class="container dashboard-container pb-5">

        <!-- HEADER -->
        <div class="d-flex justify-content-between align-items-end mb-5">
            <div>
                <h6 class="text-white-50 text-uppercase letter-spacing-2 mb-2">Member Dashboard</h6>
                <h1 class="display-4 fw-bold text-white font-orbitron">MY <span class="text-gradient-gold">GARAGE</span>
                </h1>
            </div>
            <a href="renting.html" class="btn btn-fleet-unique text-decoration-none d-none d-md-block">Book New Car</a>
        </div>

        <div class="row g-4">

            <!-- LEFT COLUMN: ACTIVE RIDE & STATS -->
            <div class="col-lg-4">

                <!-- Active Ride Card -->
                <div class="glass-panel active-ride-card p-4 mb-4" data-aos="fade-up">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5 class="text-white font-orbitron"><i class="fa-solid fa-key text-warning me-2"></i> Active
                            Ride</h5>
                        <span class="status-badge status-active">Live</span>
                    </div>

                    <img src="../images/bmwCar.jpg" class="img-fluid rounded-3 mb-3 border border-secondary"
                        alt="Active Car">

                    <h3 class="text-white font-orbitron mb-1">BMW M8</h3>
                    <p class="text-white-50 font-outfit small mb-3">Competition Gran Coupe</p>

                    <div class="d-flex justify-content-between bg-black bg-opacity-50 p-3 rounded-3 mb-3">
                        <div class="text-center">
                            <span class="d-block text-white-50 small">Time Left</span>
                            <span class="text-white fw-bold">14h 30m</span>
                        </div>
                        <div class="text-center border-start border-secondary ps-3">
                            <span class="d-block text-white-50 small">Return By</span>
                            <span class="text-warning fw-bold">Tomorrow, 10 AM</span>
                        </div>
                    </div>

                    <button class="btn btn-outline-light w-100 rounded-0 font-orbitron small">Extend Rental</button>
                    <button class="btn btn-warning w-100 mt-2 rounded-0 fw-bold font-orbitron small text-black">Unlock
                        Car</button>
                </div>

                <!-- Quick Stats -->
                <div class="row g-3">
                    <div class="col-6">
                        <div class="glass-panel p-3 text-center stat-card" data-aos="fade-up" data-aos-delay="100">
                            <i class="fa-solid fa-road text-warning fs-4 mb-2"></i>
                            <h4 class="text-white font-orbitron mb-0">1,240</h4>
                            <p class="text-white-50 small mb-0">Km Driven</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="glass-panel p-3 text-center stat-card" data-aos="fade-up" data-aos-delay="150">
                            <i class="fa-solid fa-receipt text-warning fs-4 mb-2"></i>
                            <h4 class="text-white font-orbitron mb-0">5</h4>
                            <p class="text-white-50 small mb-0">Rentals</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- RIGHT COLUMN: HISTORY -->
            <div class="col-lg-8">
                <div class="glass-panel p-4 h-100" data-aos="fade-left">
                    <h4 class="text-white font-orbitron mb-4">Rental History</h4>

                    <div class="table-responsive">
                        <table class="table history-table align-middle">
                            <thead>
                                <tr>
                                    <th>Vehicle</th>
                                    <th>Date</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center gap-3">
                                            <img src="../images/rolls_2.png" width="50" class="rounded-2" alt="RR">
                                            <div>
                                                <span class="d-block text-white fw-bold font-outfit">Rolls Royce
                                                    Ghost</span>
                                                <span class="small text-white-50">Black Badge</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>Oct 24, 2024</td>
                                    <td>2 Days</td>
                                    <td><span class="status-badge status-completed">Completed</span></td>
                                    <td class="text-warning font-outfit">$3,000</td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center gap-3">
                                            <img src="../images/maserati4k.jpg" width="50" class="rounded-2"
                                                alt="Maserati">
                                            <div>
                                                <span class="d-block text-white fw-bold font-outfit">Maserati
                                                    MC20</span>
                                                <span class="small text-white-50">Cielo</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>Sep 12, 2024</td>
                                    <td>1 Day</td>
                                    <td><span class="status-badge status-completed">Completed</span></td>
                                    <td class="text-warning font-outfit">$900</td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center gap-3">
                                            <img src="https://images.unsplash.com/photo-1617788138017-80ad40651399?q=80&w=2070&auto=format&fit=crop"
                                                width="50" class="rounded-2" alt="Porsche">
                                            <div>
                                                <span class="d-block text-white fw-bold font-outfit">Porsche
                                                    Taycan</span>
                                                <span class="small text-white-50">Turbo S</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>Aug 05, 2024</td>
                                    <td>3 Days</td>
                                    <td><span class="status-badge status-completed">Completed</span></td>
                                    <td class="text-warning font-outfit">$1,650</td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center gap-3">
                                            <img src="../images/lexus.jpg" width="50" class="rounded-2" alt="Lexus">
                                            <div>
                                                <span class="d-block text-white fw-bold font-outfit">Lexus LC500</span>
                                                <span class="small text-white-50">Inspiration</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>July 20, 2024</td>
                                    <td>1 Day</td>
                                    <td><span class="status-badge status-completed">Completed</span></td>
                                    <td class="text-warning font-outfit">$450</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- PROFILE MODAL -->
    <div id="profile-modal">
        <div class="profile-content">
            <button class="close-modal-btn" onclick="closeProfileModal()">&times;</button>

            <img src="" alt="User Avatar" class="profile-avatar-large" id="modal-avatar">

            <h2 class="text-white font-orbitron mb-1" id="modal-name">User Name</h2>
            <p class="text-white-50 font-outfit mb-4" id="modal-email">user@example.com</p>

            <div class="stat-row">
                <div class="stat-item">
                    <h3 id="modal-total-cars">0</h3>
                    <p>Cars Rented</p>
                </div>
                <div class="stat-item">
                    <h3 id="modal-total-spent">$0</h3>
                    <p>Total Spent</p>
                </div>
            </div>

            <div class="text-start mt-4">
                <h6 class="text-white font-orbitron small mb-3">GARAGE COLLECTION</h6>
                <div id="modal-car-list">
                    <!-- Tags injected here -->
                    <span class="text-white-50 small">No cars rented yet.</span>
                </div>
            </div>

            <div class="mt-4 pt-3 border-top border-secondary">
                <button onclick="logout()" class="btn btn-outline-danger w-100 rounded-pill">Logout</button>
            </div>
        </div>
    </div>

    <!-- BOOTSTRAP - JAVASCRIPT -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- AOS JS -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init({
            duration: 1000,
            once: true
        });

        async function loadDashboard() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                alert("Please login first.");
                window.location.href = "login_2.html";
                return;
            }

            // Update Name
            document.querySelector('.d-none.d-md-block.text-end .text-warning').textContent = currentUser.fullName || "Valued Member";
            document.querySelector('.user-avatar').src = `https://ui-avatars.com/api/?name=${currentUser.fullName || 'User'}&background=D4AF37&color=000`;

            try {
                const response = await fetch(`http://localhost:3000/my-bookings?email=${currentUser.email}`);
                const data = await response.json();

                if (data.success) {
                    // STORE FOR MODAL
                    window.userBookings = data.bookings;

                    const tbody = document.querySelector('.history-table tbody');
                    tbody.innerHTML = ''; // Clear default rows

                    if (data.bookings.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No bookings found. Time to ride!</td></tr>';
                    } else {
                        data.bookings.forEach(booking => {
                            const row = document.createElement('tr');

                            // Status Badge Logic
                            let badgeClass = 'status-completed';
                            if (booking.status === 'Active') badgeClass = 'status-active';

                            row.innerHTML = `
                                <td>
                                    <div class="d-flex align-items-center gap-3">
                                        <img src="${booking.carImage}" width="50" class="rounded-2" alt="${booking.carName}">
                                        <div>
                                            <span class="d-block text-white fw-bold font-outfit">${booking.carName}</span>
                                            <span class="small text-white-50">Exoticarz Fleet</span>
                                        </div>
                                    </div>
                                </td>
                                <td>${booking.startDate}</td>
                                <td>${booking.duration} Days</td>
                                <td><span class="status-badge ${badgeClass}">${booking.status}</span></td>
                                <td class="text-warning font-outfit">$${booking.totalPrice.toLocaleString()}</td>
                            `;
                            tbody.appendChild(row);

                            // If active, update the "Active Ride" card
                            if (booking.status === 'Active') {
                                document.querySelector('.active-ride-card h3').textContent = booking.carName;
                                document.querySelector('.active-ride-card img').src = booking.carImage;
                                document.querySelector('.active-ride-card .text-warning.fw-bold').textContent = "In Progress";
                            }
                        });

                        // Update Count
                        document.querySelector('.glass-panel .fa-receipt').nextElementSibling.textContent = data.bookings.length;
                    }

                }
            } catch (error) {
                console.error("Error loading dashboard:", error);
            }
        }

        // --- PROFILE MODAL LOGIC ---
        function openProfileModal() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const bookings = window.userBookings || [];

            if (!currentUser) return;

            // 1. Populate Data
            document.getElementById('modal-name').textContent = currentUser.fullName || "Valued Member";
            document.getElementById('modal-email').textContent = currentUser.email;
            document.getElementById('modal-avatar').src = `https://ui-avatars.com/api/?name=${currentUser.fullName || 'User'}&background=D4AF37&color=000`;

            // 2. Calculate Stats
            const totalCars = bookings.length;
            const totalSpent = bookings.reduce((sum, b) => sum + parseInt(b.totalPrice), 0);

            // Unique Cars
            const uniqueCars = [...new Set(bookings.map(b => b.carName))];

            document.getElementById('modal-total-cars').textContent = totalCars;
            document.getElementById('modal-total-spent').textContent = "$" + totalSpent.toLocaleString();

            const carListContainer = document.getElementById('modal-car-list');
            carListContainer.innerHTML = '';

            if (uniqueCars.length > 0) {
                uniqueCars.forEach(car => {
                    const tag = document.createElement('span');
                    tag.className = 'car-list-tag';
                    tag.textContent = car;
                    carListContainer.appendChild(tag);
                });
            } else {
                carListContainer.innerHTML = '<span class="text-white-50 small">No cars rented yet.</span>';
            }

            // 3. Show Modal
            const modal = document.getElementById('profile-modal');
            modal.style.display = 'flex';
            // Slight delay for animation
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }

        function closeProfileModal() {
            const modal = document.getElementById('profile-modal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300); // 300ms matches CSS transition
        }

        // Close on backdrop click
        document.getElementById('profile-modal').addEventListener('click', (e) => {
            if (e.target.id === 'profile-modal') {
                closeProfileModal();
            }
        });

        function logout() {
            if (confirm("Are you sure you want to logout?")) {
                localStorage.removeItem('currentUser');
                localStorage.clear(); // Nuke everything to be safe
                window.location.replace('login_2.html'); // Replace history to prevent back-button
            }
        }

        loadDashboard();
    </script>
</body>

</html>